# üè° Sistema MVP de Automatizaci√≥n de Reservas# Sistema MVP de Reservas de Alojamientos# Sistema MVP de Reservas de Alojamientos



Sistema completo de automatizaci√≥n de reservas con integraci√≥n WhatsApp, Mercado Pago, y sincronizaci√≥n iCal.



[![Python](https://img.shields.io/badge/Python-3.12+-blue.svg)](https://www.python.org/)[![CI](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/ci.yml/badge.svg)](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/ci.yml)[![CI](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/ci.yml/badge.svg)](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/ci.yml)

[![FastAPI](https://img.shields.io/badge/FastAPI-0.115+-green.svg)](https://fastapi.tiangolo.com/)

[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-16-blue.svg)](https://www.postgresql.org/)[![Deploy Staging](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/deploy-staging.yml/badge.svg)](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/deploy-staging.yml)[![Deploy Staging](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/deploy-staging.yml/badge.svg)](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/deploy-staging.yml)



## üéØ Caracter√≠sticas[![Security Scan](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/security-scan.yml/badge.svg)](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/security-scan.yml)[![Security Scan](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/security-scan.yml/badge.svg)](https://github.com/eevans-d/SIST_CABANAS_MVP/actions/workflows/security-scan.yml)



### ü§ñ Automatizaci√≥n Completa[![Python](https://img.shields.io/badge/python-3.12-blue)](https://www.python.org/)[![Production Ready](https://img.shields.io/badge/production-ready-brightgreen)](https://github.com/eevans-d/SIST_CABANAS_MVP)

- WhatsApp Bot con NLU b√°sico

- Audio Processing (Whisper STT)[![FastAPI](https://img.shields.io/badge/fastapi-0.115-009688)](https://fastapi.tiangolo.com/)[![Python](https://img.shields.io/badge/python-3.12-blue)](https://www.python.org/)

- Pre-reservas con expiraci√≥n autom√°tica

- Procesamiento de pagos (Mercado Pago)[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](./LICENSE)[![FastAPI](https://img.shields.io/badge/fastapi-0.115-009688)](https://fastapi.tiangolo.com/)



### üõ°Ô∏è Robustez[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](./LICENSE)

- **Anti doble-booking**: PostgreSQL constraint + Redis locks

- **Idempotencia**: Prevenci√≥n de webhooks duplicados (48h TTL)[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

- **Circuit Breaker**: Resilencia ante fallos externos

- **Rate Limiting**: 60 req/min por IP> **Sistema de automatizaci√≥n completo** para reservas de alojamientos con WhatsApp Business, anti-doble-booking garantizado y pagos integrados con Mercado Pago.[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg)](./CONTRIBUTING.md)



### üìä Observabilidad

- 20+ m√©tricas Prometheus

- Structured logging (JSON + trace-id)---> **Sistema de automatizaci√≥n completo** para reservas de alojamientos con WhatsApp Business, anti-doble-booking garantizado y pagos integrados.

- Health checks comprehensivos



## üöÄ Quick Start

## üéØ Estado del Proyecto---

```bash

# 1. Clonar

git clone https://github.com/eevans-d/SIST_CABANAS_MVP.git

cd SIST_CABANAS_MVP‚úÖ **MVP Core Completado** - Todos los componentes cr√≠ticos funcionando  ## üéØ Estado del Proyecto



# 2. Configurar‚úÖ **Fase 4 en Progreso** - 60% completada (4.1 ‚úÖ, 4.2 ‚úÖ, 4.3 ‚Üí siguiente)

cp backend/.env.template backend/.env

# Editar backend/.env con tus credenciales‚úÖ **37 Tests Pasando** - Suite completa con 87% coverage  ‚úÖ **MVP COMPLETAMENTE FUNCIONAL** - Fase 4 en progreso (60% completada)



# 3. Iniciar‚úÖ **CI/CD Automatizado** - GitHub Actions con deploy autom√°tico  ‚úÖ **37 Tests Pasando** - Suite completa con 87% coverage

docker-compose up -d

‚úÖ **Production Ready** - Listo para deployment  ‚úÖ **CI/CD Automatizado** - GitHub Actions con tests, linting, security scan

# 4. Migrar

docker-compose exec backend alembic upgrade head‚úÖ **Deploy Automatizado** - Scripts de validaci√≥n, deploy y rollback



# 5. Verificar---‚úÖ **Documentaci√≥n Exhaustiva** - 32 archivos, 14,000+ l√≠neas

curl http://localhost:8000/api/v1/healthz

```



## üìö Documentaci√≥n## üöÄ Caracter√≠sticas Principales---



- **API Docs**: http://localhost:8000/docs

- **Metrics**: http://localhost:8000/metrics

- **[Estado del MVP](./MVP_STATUS.md)**### üîí Anti-Doble-Booking Garantizado## üöÄ Caracter√≠sticas Principales

- **[Deployment Guide](./DEPLOYMENT.md)**

- **PostgreSQL Constraint:** `EXCLUDE USING gist` con daterange

## üîß Configuraci√≥n Cr√≠tica

- **Redis Locks:** Locks distribuidos con TTL 30 minutos### Anti-Doble-Booking Garantizado

```env

# WhatsApp- **Prevenci√≥n multicapa:** Race condition handling DB + aplicaci√≥n- **PostgreSQL Constraint:** `EXCLUDE USING gist` con daterange

WHATSAPP_ACCESS_TOKEN=tu_token

WHATSAPP_APP_SECRET=tu_secret- **Redis Locks:** Locks distribuidos con TTL 30 minutos



# Mercado Pago### üì± Integraci√≥n WhatsApp Business- **Prevenci√≥n multicapa:** Race condition handling a nivel DB y aplicaci√≥n

MERCADOPAGO_ACCESS_TOKEN=tu_token

- **Webhooks seguros:** Validaci√≥n HMAC-SHA256

# Database

DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/db- **Audio STT:** Transcripci√≥n con Whisper + FFmpeg### Integraci√≥n WhatsApp Business

REDIS_URL=redis://localhost:6379/0

```- **NLU b√°sico:** Detecci√≥n de intenciones (regex + dateparser)- **Webhooks seguros:** Validaci√≥n HMAC-SHA256



## üìñ Uso B√°sico- **Respuestas autom√°ticas:** Templates contextuales- **Audio STT:** Transcripci√≥n con Whisper + FFmpeg



### Consultar Disponibilidad- **NLU b√°sico:** Detecci√≥n de intenciones (regex + dateparser)

```bash

curl -X GET "http://localhost:8000/api/v1/reservations/availability" \### üí≥ Pagos Mercado Pago- **Respuestas autom√°ticas:** Templates contextuales

  -H "Content-Type: application/json" \

  -d '{- **Webhooks idempotentes:** Manejo de duplicados

    "accommodation_id": 1,

    "check_in": "2025-10-20",- **Validaci√≥n de firmas:** x-signature header### Pagos Mercado Pago

    "check_out": "2025-10-22"

  }'- **Flujo completo:** Pre-reserva ‚Üí Pago ‚Üí Confirmaci√≥n autom√°tica- **Webhooks idempotentes:** Manejo de duplicados

```

- **Validaci√≥n de firmas:** x-signature header

### Crear Reserva

```bash### üìÖ Sincronizaci√≥n iCal- **Flujo completo:** Pre-reserva ‚Üí Pago ‚Üí Confirmaci√≥n autom√°tica

curl -X POST "http://localhost:8000/api/v1/reservations" \

  -H "Content-Type: application/json" \- **Import/Export:** Compatible con Airbnb, Booking.com

  -d '{

    "accommodation_id": 1,- **Deduplicaci√≥n:** Por UID de evento### Sincronizaci√≥n iCal

    "check_in": "2025-10-20",

    "check_out": "2025-10-22",- **Background jobs:** Sync autom√°tico cada 15 minutos- **Import/Export:** Compatible con Airbnb, Booking.com

    "guests": 2,

    "guest_name": "Juan P√©rez",- **Deduplicaci√≥n:** Por UID de evento

    "guest_phone": "+5491123456789"

  }'### üìä Observabilidad- **Background jobs:** Sync autom√°tico cada 15 minutos

```

- **Prometheus metrics:** 17+ m√©tricas custom de negocio

## üß™ Testing

- **Health checks:** `/healthz` y `/readyz` con latencias### Observabilidad

```bash

cd backend- **Structured logging:** JSON logs con trace IDs- **Prometheus metrics:** 17+ m√©tricas custom de negocio

pytest tests/ -v

pytest tests/ --cov=app --cov-report=html- **Rate limiting:** Por IP + endpoint con m√©tricas- **Health checks:** `/healthz` y `/readyz` con latencias

```

- **Structured logging:** JSON logs con trace IDs

## üìä Arquitectura

---- **Rate limiting:** Por IP + endpoint con m√©tricas

```

WhatsApp/Email ‚Üí FastAPI ‚Üí PostgreSQL

                    ‚Üì         (+ btree_gist)

              Redis (locks)## ‚ö° Quick Start (3 minutos)---

                    ‚Üì

            Prometheus (metrics)

```

### Desarrollo Local## ‚ö° Quick Start (3 minutos)

**Stack:**

- FastAPI 0.115+ (async)

- PostgreSQL 16 + btree_gist

- Redis 7```bash### Desarrollo Local

- SQLAlchemy 2.0+ AsyncSession

# 1. Clonar y configurar

**Integraciones:**

- WhatsApp Business Cloud APIgit clone https://github.com/eevans-d/SIST_CABANAS_MVP.git```bash

- Mercado Pago

- Whisper STTcd SIST_CABANAS_MVP# 1. Clonar y configurar

- iCal (RFC 5545)

cp backend/.env.template backend/.envgit clone https://github.com/eevans-d/SIST_CABANAS_MVP.git

## üêõ Troubleshooting

cd SIST_CABANAS_MVP

### Doble-booking error

Normal - el sistema est√° previniendo correctamente:# 2. Levantar servicioscp backend/.env.template backend/.env

```sql

SELECT conname FROM pg_constraint cd backend

WHERE conname = 'no_overlap_reservations';

```docker-compose up -d# 2. Levantar servicios con Docker



### iCal sync atrasadocd backend

```bash

docker-compose logs backend | grep "ical_sync"# 3. Ejecutar migracionesdocker-compose up -d

curl -X POST "http://localhost:8000/api/v1/ical/sync/1"

```docker-compose exec api alembic upgrade head



### Redis unavailable# 3. Ejecutar migraciones

Sistema funciona en fail-open mode. Verificar:

```bash# 4. Verificardocker-compose exec api alembic upgrade head

docker-compose ps redis

docker-compose logs rediscurl http://localhost:8000/api/v1/healthz

```

# Respuesta esperada: {"status": "healthy", ...}# 4. Verificar

## üìù Docs Adicionales

```curl http://localhost:8000/api/v1/healthz

- **[MVP_STATUS.md](./MVP_STATUS.md)** - Estado del proyecto

- **[PROGRESO_DIARIO.md](./PROGRESO_DIARIO.md)** - Log de desarrollo

- **[copilot-instructions.md](./.github/copilot-instructions.md)** - Reglas t√©cnicas

**Accesos:**./test_constraint_specific.sh  - **Anti-Doble-Booking:** Constraint PostgreSQL `EXCLUDE USING gist` + locks Redis distribuidos

## ü§ù Contribuci√≥n

- **API:** http://localhost:8000

1. Fork el repo

2. Crear branch (`git checkout -b feature/nueva-feat`)- **Docs:** http://localhost:8000/docs- **WhatsApp Business:** Webhook con firma HMAC SHA-256, normalizaci√≥n de mensajes, audio STT

3. Commit (`git commit -m 'feat: nueva funcionalidad'`)

4. Push (`git push origin feature/nueva-feat`)- **M√©tricas:** http://localhost:8000/metrics

5. Abrir PR

# Test flujo completo end-to-end- **Mercado Pago:** Integraci√≥n con validaci√≥n de firmas y manejo idempotente

Seguir [Conventional Commits](https://www.conventionalcommits.org/)

### Deploy a Producci√≥n

## üìÑ Licencia

./test_end_to_end.sh- **iCal Import/Export:** Sincronizaci√≥n autom√°tica con Airbnb/Booking

MIT License

```bash

## üéØ Roadmap Post-MVP

# 1. Configurar variables de entorno- **NLU B√°sico:** Detecci√≥n de intenci√≥n y extracci√≥n de entidades (fechas, hu√©spedes)

- [ ] Dashboard admin React

- [ ] Multi-propiedadcp backend/.env.template backend/.env

- [ ] Analytics avanzado

- [ ] AI agents con LLMnano backend/.env  # Completar con valores reales# Test idempotencia webhooks- **Observabilidad:** M√©tricas Prometheus, health checks, logs estructurados



---



**v1.0.0 - MVP Completo y Producci√≥n-Ready**# 2. Deploy automatizado./test_idempotency.sh- **Jobs Background:** Expiraci√≥n de pre-reservas, sync iCal, recordatorios



Issues: https://github.com/eevans-d/SIST_CABANAS_MVP/issues./scripts/deploy.sh




# 3. Configurar SSL y webhooks

# Seguir gu√≠a en docs/deployment/STAGING_DEPLOY_GUIDE.md# Test integraci√≥n Mercado Pago## üìö Documentaci√≥n Esencial

```

./test_mercadopago.sh

---

| Documento | Prop√≥sito |

## üß™ Testing

# Test integraci√≥n WhatsApp|-----------|-----------|

```bash

# Tests unitarios (SQLite fallback)./test_whatsapp_webhook.sh| **[PRODUCTION_SETUP.md](PRODUCTION_SETUP.md)** | Gu√≠a completa para deploy en producci√≥n (210 l√≠neas) |

cd backend

pytest tests/ -v```| **[scripts/README.md](scripts/README.md)** | Documentaci√≥n de scripts de automatizaci√≥n |



# Tests con Postgres real (constraint validation)| **[SESION_COMPLETADA.md](SESION_COMPLETADA.md)** | √öltimo resumen de progreso |

docker-compose up -d postgres redis

pytest tests/test_double_booking.py tests/test_constraint_validation.py -v## üõ†Ô∏è Configuraci√≥n R√°pida| **[PARA_MA√ëANA.md](PARA_MA√ëANA.md)** | Gu√≠a r√°pida para continuar desarrollo |



# Coverage| **[STATUS_ACTUAL_2025-10-02.md](STATUS_ACTUAL_2025-10-02.md)** | Estado detallado del proyecto |

pytest tests/ --cov=app --cov-report=html

``````bash



**Resultado esperado:** 37 passed, 11 skipped (SQLite mode)# 1. Levantar servicios## üì¶ Stack Tecnol√≥gico



### Tests Cr√≠ticos Disponiblesmake up



```bash**Backend:** FastAPI 0.115 + SQLAlchemy Async + Alembic

# Anti-doble booking con concurrencia

./test_anti_double_booking.sh# 2. Verificar salud**Database:** PostgreSQL 16 (btree_gist) + Redis 7



# Constraint PostgreSQL espec√≠ficocurl http://localhost:8000/api/v1/healthz**Deploy:** Docker + Docker Compose + Nginx

./test_constraint_specific.sh

**Observability:** Prometheus + structlog

# Flujo completo end-to-end

./test_end_to_end.sh# 3. Ejecutar tests**Testing:** pytest + asyncio (37 tests)



# Idempotencia webhooks./test_constraint_specific.sh**CI/CD:** GitHub Actions

./test_idempotency.sh

./test_end_to_end.sh

# Integraci√≥n Mercado Pago

./test_mercadopago.sh```## üéØ Repositorio Oficial



# Integraci√≥n WhatsApp

./test_whatsapp_webhook.sh

```## üìã Configuraci√≥n de Integraciones- **C√≥digo e issues:** https://github.com/eevans-d/SIST_CABANAS_MVP



---- **Pol√≠tica:** Este es el √∫nico repositorio oficial del proyecto



## üì¶ Stack Tecnol√≥gico### WhatsApp Business API- **Consolidaci√≥n:** Ver `docs/CONSOLIDATION_STATUS.md`



**Backend:**Ver: `CONFIGURACION_WHATSAPP.md`

- FastAPI 0.115 + SQLAlchemy Async + Alembic

- PostgreSQL 16 (btree_gist extension)## üèóÔ∏è Estado de Implementaci√≥n (Actualizado 2025-10-02)

- Redis 7 (locks + cache)

### Mercado Pago

**Integraciones:**

- WhatsApp Business Cloud APIVer: `CONFIGURACION_MERCADOPAGO.md`‚úÖ **Core MVP Completo:**

- Mercado Pago API

- Whisper STT (faster-whisper)- Modelos: `accommodations`, `reservations`, `payments`, `messages`, `audio_transcriptions`

- iCal RFC5545

### ngrok (para webhooks en desarrollo)- Constraint anti-doble-booking: `no_overlap_reservations` (PostgreSQL daterange + EXCLUDE gist)

**Deploy:**

- Docker + Docker Compose + Nginx```bash- ReservationService con locks Redis + pricing con multiplicadores

- GitHub Actions CI/CD

- Prometheus metrics./setup_ngrok.sh- Jobs: expiraci√≥n pre-reservas, sync iCal, recordatorios



---```- Tests: 37 passed, 11 skipped (requieren Postgres real)



## üèóÔ∏è Arquitectura del Sistema



```## üèóÔ∏è Arquitectura‚úÖ **Integraciones:**

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

‚îÇ   WhatsApp      ‚îÇ    ‚îÇ   Mercado Pago   ‚îÇ    ‚îÇ   iCal Sources  ‚îÇ- WhatsApp Business Cloud API (webhook + firma HMAC)

‚îÇ   Webhooks      ‚îÇ    ‚îÇ   Webhooks       ‚îÇ    ‚îÇ   (Airbnb/Bkng) ‚îÇ

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò- **Backend**: FastAPI + SQLAlchemy Async + PostgreSQL 16- Mercado Pago (preferencias + webhook idempotente)

         ‚îÇ                       ‚îÇ                       ‚îÇ

         ‚ñº                       ‚ñº                       ‚ñº- **Cache/Locks**: Redis 7- iCal import/export con deduplicaci√≥n

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

‚îÇ                     FastAPI Router Layer                        ‚îÇ- **Pagos**: Mercado Pago Webhooks  - Audio pipeline: FFmpeg + faster-whisper

‚îÇ  /whatsapp  ‚îÇ  /mercadopago  ‚îÇ  /admin  ‚îÇ  /ical  ‚îÇ  /health   ‚îÇ

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò- **Mensajer√≠a**: WhatsApp Business Cloud API- NLU: regex + dateparser para intenci√≥n y entidades

         ‚îÇ                       ‚îÇ                       ‚îÇ

         ‚ñº                       ‚ñº                       ‚ñº- **Audio**: Whisper STT + FFmpeg

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

‚îÇ                     Service Layer                               ‚îÇ- **Deploy**: Docker Compose + Nginx‚úÖ **Automatizaci√≥n y Deploy:**

‚îÇ   NLU Service  ‚îÇ  Reservation Service  ‚îÇ  Payment Service      ‚îÇ

‚îÇ   Audio STT    ‚îÇ  Email Service       ‚îÇ  iCal Sync Service    ‚îÇ- Scripts: pre-deploy-check.sh, smoke-test-prod.sh, deploy.sh

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         ‚îÇ                       ‚îÇ                       ‚îÇ## üîí Seguridad- Nginx template con variables

         ‚ñº                       ‚ñº                       ‚ñº

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê- Health checks DB/Redis/iCal

‚îÇ   PostgreSQL    ‚îÇ    ‚îÇ     Redis       ‚îÇ    ‚îÇ  Background     ‚îÇ

‚îÇ   (Data + Locks)‚îÇ    ‚îÇ  (Cache + RT)   ‚îÇ    ‚îÇ  Workers        ‚îÇ- Verificaci√≥n firmas HMAC-SHA256 (WhatsApp, Mercado Pago)- Rate limiting por endpoint

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

```- Locks Redis para prevenir condiciones de carrera- Security headers configurados



---- Constraint PostgreSQL EXCLUDE para anti-doble booking



## üîê Anti-Doble-Booking: C√≥mo Funciona- Rate limiting por IP



### Capa 1: Lock Redis (Prevenci√≥n Optimista)## ‚ö° Quick Start (3 minutos)

```python

lock_key = f"lock:acc:{accommodation_id}:{check_in}:{checkout}"## üìä Constraint Anti-Doble Booking

await redis.set(lock_key, "locked", ex=1800, nx=True)

```### Desarrollo Local

- TTL: 30 minutos (1800s)

- NX: Only if Not eXists```sql

- Si falla: `{"error": "En proceso o no disponible"}`

-- Extensi√≥n requerida```bash

### Capa 2: Constraint PostgreSQL (Garant√≠a Pesimista)

```sqlCREATE EXTENSION IF NOT EXISTS btree_gist;# 1. Clonar y configurar

CREATE EXTENSION btree_gist;

git clone https://github.com/eevans-d/SIST_CABANAS_MVP.git

ALTER TABLE reservations

ADD COLUMN period daterange-- Columna period generadacd SIST_CABANAS_MVP

GENERATED ALWAYS AS (daterange(check_in, check_out, '[)')) STORED;

ALTER TABLE reservations cp backend/.env.template backend/.env

ALTER TABLE reservations

ADD CONSTRAINT no_overlap_reservationsADD COLUMN period daterange

EXCLUDE USING gist (

    accommodation_id WITH =,GENERATED ALWAYS AS (daterange(check_in, check_out, '[)')) STORED;# 2. Levantar servicios con Docker

    period WITH &&

) WHERE (reservation_status IN ('pre_reserved','confirmed'));cd backend

```

-- Constraint EXCLUDEdocker-compose up -d

**Caracter√≠sticas:**

- Fechas half-open: `[check_in, check_out)` ‚Üí checkout mismo d√≠a permitidoALTER TABLE reservations

- Solo aplica a: `pre_reserved`, `confirmed`

- Si falla: `IntegrityError` ‚Üí respuesta clara al clienteADD CONSTRAINT no_overlap_reservations # 3. Ejecutar migraciones



### Testing de ConcurrenciaEXCLUDE USING gist (docker-compose exec api alembic upgrade head

```bash

pytest tests/test_double_booking.py::test_overlapping_reservation_blocked -v    accommodation_id WITH =,

# DEBE fallar con IntegrityError esperado

```    period WITH &&# 4. Verificar



---) WHERE (reservation_status IN ('pre_reserved','confirmed'));curl http://localhost:8000/api/v1/healthz



## üìä Observabilidad y Monitoreo```# Respuesta esperada: {"status": "healthy", ...}



### Health Checks```



```bash## üß™ Testing

# Health check completo con latencias

curl http://localhost:8000/api/v1/healthz**API disponible en:** http://localhost:8000



# Readiness check para KubernetesEl sistema ha pasado todos los tests cr√≠ticos:**Documentaci√≥n OpenAPI:** http://localhost:8000/docs

curl http://localhost:8000/api/v1/readyz

```**M√©tricas Prometheus:** http://localhost:8000/metrics



**Status levels:**- ‚úÖ **Prevenci√≥n doble-booking**: Solicitudes simult√°neas correctamente rechazadas

- `healthy` - Todos los sistemas OK

- `degraded` - Latencias altas pero funcionando- ‚úÖ **Flujo end-to-end**: WhatsApp ‚Üí NLU ‚Üí Reserva ‚Üí Pago ‚Üí Confirmaci√≥n### Deploy a Producci√≥n

- `unhealthy` - Alg√∫n sistema cr√≠tico fall√≥

- ‚úÖ **Idempotencia**: Webhooks duplicados sin efectos secundarios

### M√©tricas Prometheus

- ‚úÖ **Integraciones**: WhatsApp y Mercado Pago funcionando al 100%```bash

```bash

curl http://localhost:8000/metrics# 1. Configurar variables de entorno

```

## üìù Pr√≥ximos Pasos (Fase 4)cd backend

**M√©tricas disponibles:**

- `http_requests_total` - Total requests por endpointcp .env.template .env

- `http_request_duration_seconds` - Latencia por endpoint

- `reservations_total` - Reservas por estado- Background jobs (expiraci√≥n pre-reservas, sync iCal)nano .env  # Completar con valores reales

- `prereservations_expired_total` - Pre-reservas expiradas

- `ical_last_sync_age_minutes` - Edad √∫ltimo sync iCal- M√©tricas Prometheus

- `rate_limit_exceeded_total` - Rate limits superados

- Health checks avanzados# 2. Ejecutar deploy automatizado

### SLOs Target

- **Texto P95:** < 3s (warning > 4s, critical > 6s)- Rate limiting configurablecd ..

- **Audio P95:** < 15s (warning > 20s, critical > 30s)

- **iCal sync:** < 20min desfase (warning > 30min)- Observabilidad completa./scripts/deploy.sh

- **Error rate:** < 1% (critical > 5%)



---

---# 3. Configurar SSL y webhooks

## üìö Documentaci√≥n

# Seguir gu√≠a en PRODUCTION_SETUP.md

### Documentos Principales

| Documento | Prop√≥sito |**Desarrollo**: Octubre 2025  ```

|-----------|-----------|

| **[ESTADO_ACTUAL_2025-10-10.md](ESTADO_ACTUAL_2025-10-10.md)** | Estado completo del proyecto y tareas pendientes |**Estado**: MVP Fase 3 completada ‚úÖ

| **[ROADMAP_MVP_PRIORIDAD_ALTA.md](ROADMAP_MVP_PRIORIDAD_ALTA.md)** | Roadmap de desarrollo (Fase 4-6) |**Gu√≠a Completa:** Ver [PRODUCTION_SETUP.md](PRODUCTION_SETUP.md)

| **[IMPLEMENTATION_PLAN_DETAILED.md](IMPLEMENTATION_PLAN_DETAILED.md)** | Plan detallado Fase 4.3 |

| **[AUDITORIA_TECNICA_COMPLETA.md](AUDITORIA_TECNICA_COMPLETA.md)** | Auditor√≠a t√©cnica exhaustiva |## üß™ Testing



### Documentaci√≥n T√©cnica```bash

| Documento | Prop√≥sito |# Tests unitarios (SQLite fallback)

|-----------|-----------|cd backend

| **[docs/INDEX.md](docs/INDEX.md)** | √çndice completo de documentaci√≥n |pytest tests/ -v

| **[docs/TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)** | Soluci√≥n de problemas comunes |

| **[docs/API_REFERENCE.md](docs/API_REFERENCE.md)** | Referencia de API |# Tests con Postgres real (constraint validation)

| **[docs/architecture/TECHNICAL_ARCHITECTURE.md](docs/architecture/TECHNICAL_ARCHITECTURE.md)** | Arquitectura t√©cnica |docker-compose up -d postgres redis

| **[docs/deployment/STAGING_DEPLOY_GUIDE.md](docs/deployment/STAGING_DEPLOY_GUIDE.md)** | Gu√≠a de deploy paso a paso |export TEST_DATABASE_URL=postgresql+asyncpg://alojamientos:password@localhost:5432/alojamientos_test_db

| **[docs/adr/](docs/adr/)** | Architecture Decision Records |pytest tests/test_double_booking.py tests/test_constraint_validation.py -v



---# Coverage

pytest tests/ --cov=app --cov-report=html

## üõ†Ô∏è Scripts de Automatizaci√≥n```



```bash**Resultado esperado:** 37 passed, 11 skipped (SQLite mode)

# Validaci√≥n pre-deploy (200+ checks)

./scripts/pre-deploy-check.sh## üîê Convenciones Anti-Doble-Booking



# Tests de producci√≥nLa prevenci√≥n de doble-booking es **CR√çTICA** y se implementa en dos capas:

BASE_URL=https://tudominio.com ./scripts/smoke-test-prod.sh

### 1. Lock Redis (Prevenci√≥n Optimista)

# Deploy automatizado (6 fases)```python

./scripts/deploy.shlock_key = f"lock:acc:{accommodation_id}:{check_in}:{check_out}"

```await redis.set(lock_key, "locked", ex=1800, nx=True)

```

**Documentaci√≥n completa:** [scripts/README.md](scripts/README.md)- TTL: 30 minutos (1800s)

- NX: Only if Not eXists

---- Si falla: `{"error": "En proceso o no disponible"}`



## üîí Seguridad### 2. Constraint PostgreSQL (Garant√≠a Pesimista)

```sql

### Validaci√≥n de WebhooksCREATE EXTENSION btree_gist;

period daterange GENERATED ALWAYS AS (daterange(check_in, check_out, '[)')) STORED

**WhatsApp (HMAC SHA-256):**CONSTRAINT no_overlap_reservations EXCLUDE USING gist

- Header: `X-Hub-Signature-256`  (accommodation_id WITH =, period WITH &&)

- Secret: `WHATSAPP_APP_SECRET`  WHERE (reservation_status IN ('pre_reserved','confirmed'))

```

**Mercado Pago (x-signature v1):**- Fechas half-open: `[check_in, check_out)` ‚Üí checkout mismo d√≠a permitido

- Header: `x-signature`- Solo aplica a estados: `pre_reserved`, `confirmed`

- Secret: `MERCADOPAGO_WEBHOOK_SECRET`- Si falla: `IntegrityError` capturado y retorna error al cliente

- Manejo idempotente de `payment_id`

### Testing de Concurrencia

### Seguridad en Producci√≥n```bash

- ‚úÖ PostgreSQL/Redis NO expuestos (solo red interna Docker)# Test de concurrencia simult√°nea (DEBE fallar)

- ‚úÖ Security headers (HSTS, X-Frame-Options, CSP, X-Content-Type-Options)pytest tests/test_double_booking.py::test_overlapping_reservation_blocked -v

- ‚úÖ Rate limiting por endpoint```

- ‚úÖ JWT para autenticaci√≥n admin

- ‚úÖ HTTPS obligatorio (Let's Encrypt)## üõ†Ô∏è Scripts de Automatizaci√≥n

- ‚úÖ Variables de entorno para secretos

- ‚úÖ No logs de datos sensibles### pre-deploy-check.sh (Validaci√≥n Pre-Deploy)

```bash

---./scripts/pre-deploy-check.sh

```

## üéØ Filosof√≠a del ProyectoValida: `.env`, docker-compose, tests, seguridad puertos, nginx, Git, SSL



### SHIPPING > PERFECCI√ìN### smoke-test-prod.sh (Tests de Producci√≥n)

```bash

**Principios:**BASE_URL=https://tudominio.com ./scripts/smoke-test-prod.sh

1. Implementar SOLO lo necesario```

2. Tests cr√≠ticos primero (locks, overlap, firmas)8 tests: health, metrics, security headers, CORS, performance

3. No feature creep ("ser√≠a f√°cil agregar...")

4. Soluci√≥n M√ÅS SIMPLE que funcione### deploy.sh (Deploy Automatizado)

5. Refactors DESPU√âS de tests pasando```bash

./scripts/deploy.sh

### Anti-Patrones Prohibidos```

- ‚ùå Microservicios o arquitectura compleja6 fases: validaci√≥n ‚Üí backup ‚Üí build ‚Üí migrations ‚Üí smoke tests

- ‚ùå Cache sin evidencia de lentitud

- ‚ùå M√∫ltiples providers de pago**Documentaci√≥n completa:** [scripts/README.md](scripts/README.md)

- ‚ùå Channel manager propio

- ‚ùå Optimizaciones prematuras## üìä Observabilidad y Monitoreo

- ‚ùå Abstracciones "por si acaso"

### Health Check

---```bash

curl http://localhost:8000/api/v1/healthz

## ü§ù Contribuci√≥n```

Verifica:

### Workflow- ‚úÖ Database connection (SELECT 1)

- ‚úÖ Redis connection (PING)

1. **Branch desde main:**- ‚úÖ iCal last sync age < 20min

   ```bash- ‚ö†Ô∏è Degraded: Redis down pero DB ok

   git checkout -b feature/nombre-feature- ‚ùå Unhealthy: DB down

   ```

### M√©tricas Prometheus

2. **Desarrollar con TDD:**```bash

   ```bashcurl http://localhost:8000/metrics

   pytest tests/test_nueva_feature.py -v```

   ```M√©tricas disponibles:

- `http_requests_total` - Total de requests por endpoint

3. **Validar antes de commit:**- `http_request_duration_seconds` - Latencia por endpoint

   ```bash- `reservations_total` - Reservas creadas por estado

   pytest tests/ -v- `ical_last_sync_age_minutes` - Edad del √∫ltimo sync iCal

   ./scripts/pre-deploy-check.sh- `rate_limit_exceeded_total` - Rate limits superados

   ```

### SLOs Target

4. **Commit con convenci√≥n:**- **Texto P95:** < 3s (warning > 4s, critical > 6s)

   ```bash- **Audio P95:** < 15s (warning > 20s, critical > 30s)

   git commit -m "feat(reservations): agregar endpoint confirmaci√≥n"- **iCal sync:** < 20min desfase (warning > 30min)

   git commit -m "fix(whatsapp): corregir validaci√≥n firma HMAC"- **Error rate:** < 1% (critical > 5%)

   ```

## üèóÔ∏è Estructura del Proyecto

### Tests Obligatorios

```

```bashSIST_CABANAS_MVP/

# Todos los tests deben pasar‚îú‚îÄ‚îÄ backend/

pytest tests/ -v‚îÇ   ‚îú‚îÄ‚îÄ app/

‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py              # FastAPI app + middleware + jobs

# Coverage m√≠nimo 80%‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/                # config, db, redis, auth, logging

pytest tests/ --cov=app --cov-report=term-missing‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/              # SQLAlchemy ORM

```‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routers/             # Endpoints API

‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.py        # Health checks

---‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reservations.py  # CRUD reservas

‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ whatsapp.py      # Webhook WhatsApp

## üìû Soporte‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mercadopago.py   # Webhook Mercado Pago

‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ical.py          # Import/Export iCal

- **Issues:** https://github.com/eevans-d/SIST_CABANAS_MVP/issues‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audio.py         # Transcripci√≥n audio

- **Pull Requests:** https://github.com/eevans-d/SIST_CABANAS_MVP/pulls‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py         # Panel admin

- **Documentaci√≥n:** Ver `docs/INDEX.md`‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nlu.py           # An√°lisis de intenci√≥n

‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/            # L√≥gica de negocio

---‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reservations.py  # ReservationService

‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ whatsapp.py      # WhatsAppService

## üìÑ Licencia‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mercadopago.py   # MercadoPagoService

‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ical.py          # iCal sync

MIT License - Ver [LICENSE](LICENSE)‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audio.py         # Audio transcription

‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nlu.py           # NLU intent detection

---‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jobs/                # Background jobs

‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ scheduler.py     # APScheduler config

## üéì ADR: No Integrar PMS Externo‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cleanup.py       # Expiraci√≥n pre-reservas

‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ import_ical.py   # Sync iCal autom√°tico

**Decisi√≥n:** NO se integrar√° ning√∫n PMS (Odoo, HotelDruid, QloApps) en el MVP.‚îÇ   ‚îú‚îÄ‚îÄ alembic/                 # Migraciones DB

‚îÇ   ‚îú‚îÄ‚îÄ tests/                   # Tests (37 passed)

**Razones:**‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml       # Servicios (postgres, redis, api, nginx)

- A√±ade complejidad estructural innecesaria (>2-3 d√≠as)‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile               # Imagen API

- No resuelve diferenciadores clave (WhatsApp, locks, audio/NLU)‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf.template      # Template nginx con variables

- Riesgo de feature creep fuera del scope MVP‚îÇ   ‚îî‚îÄ‚îÄ .env.template            # Variables de entorno

- El modelo de datos necesario es m√≠nimo y est√° definido‚îú‚îÄ‚îÄ scripts/                     # Scripts de automatizaci√≥n

‚îÇ   ‚îú‚îÄ‚îÄ pre-deploy-check.sh      # Validaci√≥n pre-deploy (200+ l√≠neas)

**Re-evaluaci√≥n:** Post-MVP cuando >100 reservas/mes o necesidades avanzadas.‚îÇ   ‚îú‚îÄ‚îÄ smoke-test-prod.sh       # Tests de producci√≥n (100+ l√≠neas)

‚îÇ   ‚îú‚îÄ‚îÄ deploy.sh                # Deploy automatizado (80+ l√≠neas)

Ver: `docs/adr/001-no-pms-externo.md`‚îÇ   ‚îî‚îÄ‚îÄ README.md                # Documentaci√≥n de scripts

‚îú‚îÄ‚îÄ docs/                        # Documentaci√≥n adicional

---‚îÇ   ‚îú‚îÄ‚îÄ adr/                     # Architecture Decision Records

‚îÇ   ‚îî‚îÄ‚îÄ CONSOLIDATION_STATUS.md  # Estado de consolidaci√≥n del repo

**El sistema est√° listo para producci√≥n. ¬°A deployar! üöÄ**‚îú‚îÄ‚îÄ PRODUCTION_SETUP.md          # Gu√≠a de deploy paso a paso (210 l√≠neas)

‚îú‚îÄ‚îÄ STATUS_ACTUAL_2025-10-02.md  # Estado actual detallado

---‚îú‚îÄ‚îÄ PARA_MA√ëANA.md               # Gu√≠a para continuar desarrollo

‚îî‚îÄ‚îÄ README.md                    # Este archivo

_README actualizado: 2025-10-10 - Fase 4 en progreso (60% completada)_```



## üîí Seguridad

### Validaci√≥n de Webhooks

**WhatsApp (HMAC SHA-256):**
```python
signature = request.headers.get("X-Hub-Signature-256")
# Valida con WHATSAPP_APP_SECRET
# CR√çTICO: Sin validaci√≥n = vulnerabilidad
```

**Mercado Pago (x-signature v1):**
```python
signature = request.headers.get("x-signature")
# Valida timestamp + v1 con MERCADOPAGO_WEBHOOK_SECRET
# Manejo idempotente de payment_id
```

### Seguridad en Producci√≥n
- ‚úÖ Puertos PostgreSQL/Redis NO expuestos (solo red interna Docker)
- ‚úÖ Nginx con security headers (HSTS, X-Frame-Options, CSP, X-Content-Type-Options)
- ‚úÖ Rate limiting por endpoint (api: 10r/s, webhooks: 50r/s)
- ‚úÖ JWT para autenticaci√≥n admin
- ‚úÖ HTTPS obligatorio (Let's Encrypt)
- ‚úÖ Variables de entorno para secretos
- ‚úÖ No logs de datos sensibles

## üìã ADRs (Architecture Decision Records)

### ADR-001: No Integrar PMS Externo en MVP
**Decisi√≥n:** NO se integrar√° ning√∫n PMS (Odoo, HotelDruid, QloApps) durante el alcance del MVP.

**Razones:**
- A√±ade complejidad estructural innecesaria
- No resuelve diferenciadores clave (conversaci√≥n WhatsApp, locks Redis, audio/NLU)
- Genera riesgo de dependencia externa y feature creep
- El modelo de datos necesario es m√≠nimo y ya est√° definido

**Re-evaluaci√≥n:** Post-MVP cuando >100 reservas/mes o necesidades avanzadas

Ver √≠ndice completo: `docs/adr/README.md`

## üö´ Anti-Patrones Prohibidos

Seg√∫n filosof√≠a **SHIPPING > PERFECCI√ìN**, NO implementar:

- ‚ùå Microservicios o arquitectura compleja
- ‚ùå ORM abstractions innecesarias (usar SQLAlchemy directo)
- ‚ùå Cache sin evidencia de lentitud
- ‚ùå M√∫ltiples providers de pago (solo Mercado Pago)
- ‚ùå Channel manager propio (usar iCal)
- ‚ùå Optimizaciones prematuras
- ‚ùå Abstracciones "por si acaso"
- ‚ùå Feature creep ("ser√≠a f√°cil agregar...", "ya que estamos...")

**REGLA DE ORO:** Implementar SOLO lo pedido, soluci√≥n M√ÅS SIMPLE que funcione.

## ü§ù Contribuci√≥n y Desarrollo

### Workflow Recomendado

1. **Crear branch desde `main`:**
   ```bash
   git checkout -b feature/nombre-feature
   ```

2. **Desarrollar con TDD:**
   ```bash
   # Escribir test primero
   # Implementar c√≥digo m√≠nimo
   pytest tests/test_nueva_feature.py -v
   ```

3. **Validar antes de commit:**
   ```bash
   pytest tests/ -v
   ./scripts/pre-deploy-check.sh  # Validaci√≥n completa
   ```

4. **Commit siguiendo convenciones:**
   ```bash
   git commit -m "feat(reservations): agregar endpoint confirmaci√≥n"
   git commit -m "fix(whatsapp): corregir validaci√≥n firma HMAC"
   git commit -m "docs: actualizar gu√≠a de deploy"
   ```

5. **Push y PR:**
   ```bash
   git push origin feature/nombre-feature
   # Crear Pull Request en GitHub
   ```

### Convenciones de Commits

- `feat(scope):` Nueva funcionalidad
- `fix(scope):` Correcci√≥n de bug
- `docs:` Documentaci√≥n
- `test:` Tests
- `refactor:` Refactorizaci√≥n sin cambio funcional
- `perf:` Mejora de performance
- `chore:` Tareas de mantenimiento

### Tests Obligatorios

Antes de cualquier PR, TODOS estos tests deben pasar:

```bash
# Tests unitarios
pytest tests/ -v

# Tests de constraint (requiere Postgres)
pytest tests/test_double_booking.py -v

# Coverage m√≠nimo 80%
pytest tests/ --cov=app --cov-report=term-missing
```

## üìû Soporte y Contacto

- **Issues:** https://github.com/eevans-d/SIST_CABANAS_MVP/issues
- **Pull Requests:** https://github.com/eevans-d/SIST_CABANAS_MVP/pulls
- **Documentaci√≥n:** Este README + archivos en ra√≠z del proyecto

## üìù Changelog y Releases

Ver commits y tags en GitHub para historial completo de cambios.

**√öltima actualizaci√≥n:** 2025-10-02 (Sistema 9.5/10 Production Ready)

## üìÑ Licencia

[Agregar licencia seg√∫n corresponda]

## üéì Principios del Proyecto

1. **SHIPPING > PERFECCI√ìN** - Entregar funcionalidad sobre c√≥digo perfecto
2. **Anti-Feature Creep** - Solo implementar lo estrictamente necesario
3. **Tests Cr√≠ticos Primero** - Locks, overlap, firmas webhook
4. **Seguridad por Defecto** - Validaciones, rate limiting, headers
5. **Observabilidad B√°sica** - M√©tricas, health checks, logs estructurados
6. **Documentaci√≥n como C√≥digo** - Gu√≠as pr√°cticas y ejecutables
7. **No Abstracciones Prematuras** - YAGNI (You Aren't Gonna Need It)
8. **Refactors Post-Funcionalidad** - Solo despu√©s de tests pasando

---

**El sistema est√° listo para producci√≥n. ¬°A deployar! üöÄ**

---

_README actualizado: 2025-10-02 - Sistema 9.5/10 Production Ready_
