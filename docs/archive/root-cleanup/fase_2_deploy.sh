#!/bin/bash

# ============================================================================
# FASE 2: DEPLOY A PRODUCCIรN
# ============================================================================
# Este script automatiza:
# 1. Re-validaciรณn pre-deploy (debe mostrar 15/15 โ)
# 2. Deploy a Fly.io
# 3. Monitoreo de logs en tiempo real
# ============================================================================

set -e

export PATH="/home/eevan/.fly/bin:$PATH"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                      ๐ FASE 2: DEPLOY A PRODUCCIรN                           โ"
echo "โ                    Build + Release + Health Check                              โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

cd "$(dirname "$0")"

# ============================================================================
# PRE-REQUISITOS
# ============================================================================

echo "โณ Verificando pre-requisitos..."

if ! command -v flyctl &> /dev/null; then
    echo "โ flyctl no instalado."
    exit 1
fi

if ! flyctl auth whoami &> /dev/null; then
    echo "โ No autenticado con Fly.io."
    exit 1
fi

echo "โ Prerequisitos OK"
echo ""

# ============================================================================
# RE-VALIDACIรN PRE-DEPLOY
# ============================================================================

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "RE-VALIDACIรN PRE-DEPLOY"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ -f "./pre_deploy_validation.sh" ]; then
    echo "โณ Ejecutando validaciรณn..."
    bash ./pre_deploy_validation.sh

    VALIDATION_RESULT=$?
    if [ $VALIDATION_RESULT -ne 0 ]; then
        echo ""
        echo "โ VALIDACIรN FALLIDA"
        echo "โ๏ธ  No se puede desplegar. Revisa los errores arriba."
        exit 1
    fi
    echo "โ VALIDACIรN EXITOSA: 15/15 โ"
else
    echo "โ๏ธ  pre_deploy_validation.sh no encontrado - saltando validaciรณn"
fi

echo ""

# ============================================================================
# DEPLOY A FLY.IO
# ============================================================================

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "DEPLOY A FLY.IO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo "โณ Iniciando deploy de sist-cabanas-mvp..."
echo "   (Esto puede tomar 2-5 minutos. Sistema en zero-downtime)"
echo ""

flyctl deploy \
    --app sist-cabanas-mvp \
    --strategy immediate \
    --wait-timeout 5m

DEPLOY_RESULT=$?

echo ""

if [ $DEPLOY_RESULT -ne 0 ]; then
    echo "โ DEPLOY FALLIDO"
    echo "โน๏ธ  Ejecuta para ver logs detallados:"
    echo "    flyctl logs -f --app sist-cabanas-mvp"
    exit 1
fi

echo "โ DEPLOY COMPLETADO EXITOSAMENTE"
echo ""

# ============================================================================
# MONITOREO DE LOGS
# ============================================================================

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "MONITOREO DE LOGS EN VIVO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo "โณ Esperando 5 segundos para que app estรฉ lista..."
sleep 5

echo ""
echo "๐ Logs en vivo (รบltimas 20 lรญneas, Ctrl+C para salir):"
echo ""

timeout 30 flyctl logs -f --app sist-cabanas-mvp 2>/dev/null || true

echo ""
echo "โ Monitoreo completado"
echo ""

# ============================================================================
# INFORMACIรN DE DEPLOY
# ============================================================================

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "INFORMACIรN DE DEPLOY"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo "๐ Estado de la aplicaciรณn:"
flyctl status --app sist-cabanas-mvp

echo ""
echo "๐ URL de producciรณn:"
echo "   https://sist-cabanas-mvp.fly.dev"
echo ""

echo "๐ Dashboard de Fly.io:"
echo "   https://fly.io/apps/sist-cabanas-mvp"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                    โ FASE 2 COMPLETADA EXITOSAMENTE                          โ"
echo "โ                                                                                โ"
echo "โ  Next: FASE 3 - Smoke Tests (5 tests crรญticos)                                โ"
echo "โ  Comando: bash fase_3_smoke_tests.sh                                          โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
