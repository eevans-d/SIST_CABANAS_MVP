# Daily Log - 2025-09-24

## Resumen de Avances
- Se consolidó la base del modelo de datos principal: `accommodations` y `reservations`.
- Se creó migración inicial `001_initial_schema.py` con:
  - `CREATE EXTENSION IF NOT EXISTS btree_gist`.
  - Columna `period` (daterange) generada y constraint `no_overlap_reservations` (EXCLUDE gist) para evitar doble-booking en estados `pre_reserved|confirmed`.
- Implementados tests de integridad anti doble-booking:
  - `test_double_booking.py` (casos básicos consecutivos, overlap, cancel).
  - `test_constraint_validation.py` (escenarios extendidos: pre_reserved bloquea, overlaps parciales, boundary half-open, error message assertions, multi alojamiento).
- Fixtures avanzadas (`conftest.py`) con:
  - Fallback PostgreSQL -> SQLite in-memory.
  - Redis / fakeredis.
  - Factories de modelos.
  - Sesión transaccional aislada.
- Ajustes en Dockerfile (healthcheck) y health check DB (uso de `text("SELECT 1")`).
- Estructura ADR creada + ADR-001 (No PMS externo en MVP).
- Instrucciones operativas para desarrollo AI-assisted en `.github/copilot-instructions.md` alineadas al alcance MVP.

## Pendientes Prioritarios Próxima Jornada
1. Servicio de Reservas (`services/reservations.py`): lógica de pre-reserva con lock Redis + pricing simple.
2. Implementar expiración de pre-reservas (job cleanup).
3. Router webhook WhatsApp (firma HMAC + normalización de mensaje).
4. Servicio Mercado Pago (creación de preferencia mock inicial + webhook idempotente base).
5. Health `/healthz` extender con: latencia Redis, edad última sync iCal (placeholder), reachability WhatsApp/MP (HEAD o request simple con timeout corto).
6. Métricas Prometheus básicas (requests, latencia, locks contados, reservas creadas/error de constraint).
7. Plantilla de migración siguiente para futuras tablas (payments, whatsapp_messages, processed_audio).

## Riesgos / Notas
- Tests anti-overlap sólo válidos contra Postgres real: asegurar `TEST_DATABASE_URL` apunta a instancia levantada en CI.
- Falta aún pipeline de audio y NLU; no bloquear lo crítico de reservas.
- Evaluar agregar índice parcial para reservas activas según volumetría futura.

## Variables Entorno Clave (recordatorio)
- `DATABASE_URL`, `TEST_DATABASE_URL`, `REDIS_URL`, `WHATSAPP_APP_SECRET`, `MERCADOPAGO_ACCESS_TOKEN`, `JWT_SECRET`.

## Siguiente Paso Inmediato (mañana)
Iniciar por ReservationService + Redis lock, luego webhook WhatsApp para habilitar canal conversacional mínimo.

---
_Log generado automáticamente._
